<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Temperaturas</title>

<style>
* { box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
  margin: 0;
  padding: 20px;
  display: flex;
  justify-content: center;
}

.container {
  background: white;
  padding: 30px;
  border-radius: 16px;
  max-width: 1100px;
  width: 100%;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

h2, h3 {
  text-align: center;
  margin-bottom: 20px;
}

/* ===== GRID DOS INPUTS ===== */
.form-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

.form-grid input {
  margin-bottom: 0;
}

.form-full {
  margin-top: 12px;
}

/* ===== INPUTS ===== */
input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 15px;
  transition: 0.2s;
}

input:focus {
  border-color: #4a90e2;
  outline: none;
  box-shadow: 0 0 0 2px rgba(74,144,226,0.15);
}

/* ===== BOTÕES ===== */
button {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  margin: 8px 5px 10px 0;
  transition: 0.2s;
}

button:hover {
  transform: translateY(-2px);
}

#btnLogin, #btnSalvar { background: #4a90e2; color: white; }
#btnLogout { background: #e74c3c; color: white; }
#btnCSV { background: #27ae60; color: white; }
#btnCriarUsuario { background: #8e44ad; color: white; }

/* ===== TABELA DESKTOP ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th {
  background: #4a90e2;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #eee;
}

tr:hover {
  background: #f8fafc;
}

.admin-panel {
  background: #f3f6fa;
  padding: 20px;
  border-radius: 12px;
  margin-top: 25px;
}

/* ================= MOBILE ================= */
@media (max-width: 900px) {

  body { padding: 10px; }

  .container {
    padding: 20px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  button {
    width: 100%;
  }

  /* Tabela vira card */
  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }

  thead {
    display: none;
  }

  tr {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 14px;
    background: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.06);
  }

  td {
    text-align: left;
    padding: 8px 0;
    border: none;
    font-size: 16px;
  }

  td::before {
    content: attr(data-label);
    display: block;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
    color: #666;
  }
}
</style>

</head>

<body>
<div class="container">

<h2>Controle de Temperaturas</h2>

<div id="loginDiv">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div id="appDiv" style="display:none">

<button id="btnLogout">Sair</button>

<h3>Novo Registro</h3>

<div class="form-grid">
  <input type="number" id="tempAtual" placeholder="Temp Atual (°C)">
  <input type="number" id="tempMin" placeholder="Temp Mínima (°C)">
  <input type="number" id="tempMax" placeholder="Temp Máxima (°C)">
  <input type="number" id="umi" placeholder="Umidade (%)">
</div>

<input
  type="text"
  id="dataHora"
  placeholder="Clique para selecionar data e hora"
  onfocus="this.type='datetime-local'"
  onblur="if(!this.value)this.type='text'">

<button id="btnSalvar">Salvar</button>
<button id="btnCSV">Baixar CSV</button>

<table>
<thead>
<tr>
  <th>Data/Hora</th>
  <th>Temp Atual</th>
  <th>Temp Min</th>
  <th>Temp Max</th>
  <th>Umidade</th>
  <th>Usuário</th>
  <th>Ações</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<div id="adminDiv" class="admin-panel" style="display:none">
  <h3>Painel Admin - Criar Usuário</h3>
  <input type="email" id="novoEmail" placeholder="Email">
  <input type="password" id="novaSenha" placeholder="Senha">
  <button id="btnCriarUsuario">Criar Usuário</button>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPzCMPdw4aoA27_AqnvGkNhDc2flkK9QM",
  authDomain: "controletemumi.firebaseapp.com",
  databaseURL: "https://controletemumi-default-rtdb.firebaseio.com",
  projectId: "controletemumi",
  storageBucket: "controletemumi.firebasestorage.app",
  messagingSenderId: "599539401138",
  appId: "1:599539401138:web:a8124bb9dd0835697464ab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let editandoId = null;

btnLogin.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert(e.message));
};

btnLogout.onclick = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if(user){
    loginDiv.style.display="none";
    appDiv.style.display="block";

    const snap = await get(ref(db,"users/"+user.uid));
    adminDiv.style.display = snap.exists() && snap.val().role === "admin" ? "block" : "none";

    carregar();
  } else {
    loginDiv.style.display="block";
    appDiv.style.display="none";
  }
});

btnSalvar.onclick = async () => {
  if(!tempAtual.value || !tempMin.value || !tempMax.value || !umi.value || !dataHora.value){
    alert("Preencha todos os campos");
    return;
  }

  const dados = {
    tempAtual: tempAtual.value,
    tempMin: tempMin.value,
    tempMax: tempMax.value,
    umidade: umi.value,
    dataHora: dataHora.value,
    usuario: auth.currentUser.email,
    uid: auth.currentUser.uid
  };

  if(editandoId){
    await update(ref(db,"registros/"+editandoId), dados);
    editandoId = null;
  } else {
    await set(push(ref(db,"registros")), dados);
  }

  tempAtual.value = "";
  tempMin.value = "";
  tempMax.value = "";
  umi.value = "";
  dataHora.value = "";
};

function carregar(){
  onValue(ref(db,"registros"), snap => {
    tabela.innerHTML = "";
    snap.forEach(child => {
      const d = child.val();
      tabela.innerHTML += `
<tr>
  <td data-label="Data/Hora">${d.dataHora}</td>
  <td data-label="Temp Atual">${d.tempAtual}</td>
  <td data-label="Temp Min">${d.tempMin}</td>
  <td data-label="Temp Max">${d.tempMax}</td>
  <td data-label="Umidade">${d.umidade}</td>
  <td data-label="Usuário">${d.usuario}</td>
  <td data-label="Ações">
    <button onclick="window.editar('${child.key}')">Editar</button>
    <button onclick="window.excluir('${child.key}')">Excluir</button>
  </td>
</tr>`;
    });
  });
}

window.excluir = id => remove(ref(db,"registros/"+id));

window.editar = async id => {
  const snap = await get(ref(db,"registros/"+id));
  const d = snap.val();
  tempAtual.value = d.tempAtual;
  tempMin.value = d.tempMin;
  tempMax.value = d.tempMax;
  umi.value = d.umidade;
  dataHora.value = d.dataHora;
  editandoId = id;
};

btnCriarUsuario.onclick = async () => {
  const cred = await createUserWithEmailAndPassword(auth, novoEmail.value, novaSenha.value);
  await set(ref(db,"users/"+cred.user.uid), { email: novoEmail.value, role:"user" });
  alert("Usuário criado");
};

btnCSV.onclick = async () => {
  const snap = await get(ref(db,"registros"));
  let csv = "Data;Hora;Temp Atual;Temp Min;Temp Max;Umidade;Usuário\n";

  snap.forEach(child => {
    const d = child.val();
    const dt = new Date(d.dataHora);
    csv += `${dt.toLocaleDateString("pt-BR")};${dt.toLocaleTimeString("pt-BR")};${d.tempAtual};${d.tempMin};${d.tempMax};${d.umidade};${d.usuario}\n`;
  });

  const blob = new Blob(["\ufeff"+csv], { type:"text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "registros_temperaturas.csv";
  a.click();
};
</script>

</body>
</html>
